<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사지선다 객관식 퀴즈</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 적용 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 타이머 바 스타일 */
        .timer-bar-container {
            width: 100%;
            background-color: #e2e8f0; /* gray-200 */
            border-radius: 9999px; /* full rounded */
            height: 12px; /* h-3 */
            overflow: hidden;
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: #ef4444; /* red-500 */
            border-radius: 9999px; /* full rounded */
            transition: width linear; /* 부드러운 전환 효과 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="bg-white rounded-xl shadow-lg p-8 w-full max-w-2xl text-center flex flex-col items-center">

        <!-- 초기 화면 (퀴즈 시작) -->
        <div id="start-screen" class="space-y-6">
            <!-- 아시아경제 로고 이미지 추가 -->
            <img src="https://raw.githubusercontent.com/parkjovio/quiz-app/main/aklogo.png" alt="아시아경제 로고" class="w-48 h-auto mx-auto mb-4 rounded-lg shadow-md">
            <h1 class="text-4xl font-extrabold text-blue-700 mb-6">AK! 스타일북 완전 내 스탈♡</h1>
            <p class="text-lg text-gray-700 mb-8">
                (최신판 적용 - 콘텐츠편집2팀&교열팀)
            </p>
            <button id="start-quiz-button" onclick="startQuizFromGoogleSheet()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                퀴즈 시작
            </button>
            <div id="error-message" class="text-red-600 font-semibold mt-4 hidden"></div>
        </div>

        <!-- 로딩 화면 -->
        <div id="loading-screen" class="hidden flex flex-col items-center justify-center space-y-4">
            <div class="spinner"></div>
            <p class="text-xl text-gray-700">문제 로딩 중...</p>
        </div>

        <!-- 퀴즈 화면 -->
        <div id="quiz-screen" class="hidden w-full space-y-6">
            <!-- 타이머 바 추가 -->
            <div class="timer-bar-container">
                <div id="timer-bar" class="timer-bar"></div>
            </div>
            <h2 id="question-number" class="text-2xl font-semibold text-gray-800">문제 1/10</h2>
            <p id="question-text" class="text-3xl font-bold text-gray-900 leading-relaxed mb-6"></p>

            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 옵션 버튼들이 여기에 동적으로 삽입됩니다 -->
            </div>

            <div id="feedback" class="mt-6 text-2xl font-bold"></div>
        </div>

        <!-- 결과 화면 -->
        <div id="result-screen" class="hidden flex flex-col items-center space-y-6">
            <h2 class="text-3xl font-bold text-blue-700">퀴즈 결과</h2>
            <p id="score-text" class="text-4xl font-extrabold text-green-600"></p>
            <!-- 추가된 문구 및 링크 -->
            <p class="text-lg text-gray-700 mt-4">
                아시아경제 스타일북에서 더 많은 정보를 찾아보세요(<a href="https://docs.google.com/document/d/14GE_DdYGSZ8PAJdLfQJFIWB3Obo1K0hxId4ITytriXs/edit?usp=sharing" target="_blank" class="font-bold text-blue-600 hover:underline">클릭</a>)
            </p>
            <p class="text-sm text-gray-500 mt-2">
                기획 : 박충훈, 코딩 : 제미나이 2.5pro
            </p>
            <img id="ending-image" src="https://placehold.co/400x200/ADD8E6/000000?text=Quiz+Complete!" alt="퀴즈 완료 이미지" class="rounded-lg shadow-md max-w-full h-auto">
            <div class="flex flex-col md:flex-row gap-4 mt-6">
                <button onclick="resetQuiz()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    초기 화면으로 돌아가기
                </button>
                <button onclick="playAgain()"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                    다른 문제 풀어보기
                </button>
            </div>
        </div>

    </div>

    <script>
        // Google Sheet의 CSV export URL
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1W25qlkdLdIAB2Z3C176wmB5o-7Aovrlm0oDLsJOuVSo/export?format=csv&gid=0';

        let allQuestions = [];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let correctAnswersCount = 0;
        let quizStarted = false;

        // 타이머 관련 변수
        const TIME_LIMIT = 20; // 각 문제당 제한 시간 (초)
        let timeLeft = TIME_LIMIT;
        let timerInterval;
        const timerBar = document.getElementById('timer-bar');

        const startScreen = document.getElementById('start-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');

        const questionNumberElem = document.getElementById('question-number');
        const questionTextElem = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackElem = document.getElementById('feedback');
        const scoreTextElem = document.getElementById('score-text');
        const endingImageElem = document.getElementById('ending-image');
        const startQuizButton = document.getElementById('start-quiz-button');
        const errorMessageElem = document.getElementById('error-message');

        /**
         * Google Sheet에서 CSV 데이터를 불러와 퀴즈를 시작합니다.
         */
        async function startQuizFromGoogleSheet() {
            // 화면 전환: 시작 -> 로딩
            startScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            errorMessageElem.classList.add('hidden'); // 에러 메시지 숨김

            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`데이터를 불러오는 데 실패했습니다 (HTTP 상태: ${response.status}). Google Sheet가 '웹에 게시'되었는지, 그리고 링크가 올바른지 확인해주세요.`);
                }
                const csvText = await response.text();
                parseCSV(csvText);

                if (allQuestions.length === 0) {
                    throw new Error('Google Sheet에서 유효한 문제를 찾을 수 없습니다. 파일 형식이 올바른지 확인해주세요.');
                }

                // 100개 중 10개 무작위 선택 (중복 없이)
                currentQuizQuestions = [];
                const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
                currentQuizQuestions = shuffled.slice(0, 10);

                if (currentQuizQuestions.length < 10) {
                    throw new Error(`문제가 부족합니다. 최소 10개의 문제가 필요합니다. 현재 ${allQuestions.length}개.`);
                }

                currentQuestionIndex = 0;
                correctAnswersCount = 0;
                quizStarted = true;
                feedbackElem.textContent = ''; // 피드백 초기화

                // 로딩 화면 표시 후 퀴즈 화면으로 전환
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    quizScreen.classList.remove('hidden');
                    displayQuestion();
                }, 1000); // 1초 로딩 지연

            } catch (error) {
                console.error('퀴즈 로드 중 오류 발생:', error);
                if (error.message.includes('Failed to fetch')) {
                    showError('퀴즈 로드 실패: 네트워크 연결을 확인하거나, Google Sheet가 \'웹에 게시\'되어 모든 사용자가 CSV 형식으로 접근 가능한지 확인해주세요.');
                } else {
                    showError(`퀴즈 로드 실패: ${error.message}`);
                }
                resetQuiz();
            }
        }

        /**
         * CSV 텍스트를 파싱하여 문제 객체 배열로 변환합니다.
         */
        function parseCSV(csvText) {
            allQuestions = [];
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                const parts = [];
                let inQuote = false;
                let currentPart = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        parts.push(currentPart.trim());
                        currentPart = '';
                    } else {
                        currentPart += char;
                    }
                }
                parts.push(currentPart.trim());

                if (parts.length >= 6) {
                    const question = parts[0].replace(/^"|"$/g, '').trim();
                    const options = parts.slice(1, 5).map(opt => opt.replace(/^"|"$/g, '').trim());
                    const correctAnswerIndex = parseInt(parts[5].trim(), 10) - 1;

                    if (!isNaN(correctAnswerIndex) && correctAnswerIndex >= 0 && correctAnswerIndex < 4) {
                        allQuestions.push({
                            question: question,
                            options: options,
                            correctAnswerIndex: correctAnswerIndex
                        });
                    } else {
                        console.warn('잘못된 정답 인덱스 또는 형식:', line);
                    }
                } else {
                    console.warn('잘못된 CSV 줄 형식 (필드 수 부족):', line);
                }
            });
            console.log('파싱된 문제 수:', allQuestions.length);
        }

        /**
         * 에러 메시지를 표시합니다.
         */
        function showError(message) {
            errorMessageElem.textContent = message;
            errorMessageElem.classList.remove('hidden');
            startScreen.classList.remove('hidden');
            loadingScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
        }

        /**
         * 현재 문제를 화면에 표시하고 타이머를 시작합니다.
         */
        function displayQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                showResults();
                return;
            }

            // 이전 타이머가 있다면 중지
            clearInterval(timerInterval);
            timeLeft = TIME_LIMIT; // 시간 초기화
            timerBar.style.width = '100%'; // 타이머 바 너비 초기화
            timerBar.style.backgroundColor = '#ef4444'; // 빨간색으로 초기화 (red-500)

            const questionData = currentQuizQuestions[currentQuestionIndex];
            questionNumberElem.textContent = `문제 ${currentQuestionIndex + 1}/10`;
            questionTextElem.textContent = questionData.question;
            optionsContainer.innerHTML = '';
            feedbackElem.textContent = '';

            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = `${index + 1}. ${option}`;
                button.className = 'option-button bg-blue-100 text-blue-800 font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-blue-200 transition duration-200 text-left';
                button.onclick = () => checkAnswer(index);
                optionsContainer.appendChild(button);
            });

            startTimer(); // 타이머 시작
        }

        /**
         * 타이머를 시작합니다.
         */
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft -= 0.1; // 0.1초씩 감소
                const percentage = (timeLeft / TIME_LIMIT) * 100;
                timerBar.style.width = `${percentage}%`;

                // 시간 경과에 따라 색상 변경 (선택 사항)
                if (percentage <= 25) {
                    timerBar.style.backgroundColor = '#f97316'; // 주황색 (orange-500)
                } else if (percentage <= 50) {
                    timerBar.style.backgroundColor = '#f59e0b'; // 노란색 (amber-500)
                } else {
                    timerBar.style.backgroundColor = '#ef4444'; // 빨간색 (red-500)
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerBar.style.width = '0%';
                    // 시간이 다 되면 오답 처리
                    markAnswerIncorrectByTimeout();
                }
            }, 100); // 100ms마다 업데이트
        }

        /**
         * 시간 초과로 답변이 틀렸을 때 처리합니다.
         */
        function markAnswerIncorrectByTimeout() {
            feedbackElem.textContent = '시간 초과! 오답입니다.';
            feedbackElem.className = 'mt-6 text-2xl font-bold text-red-600';

            const questionData = currentQuizQuestions[currentQuestionIndex];
            const optionButtons = document.querySelectorAll('.option-button');

            // 모든 버튼 비활성화
            optionButtons.forEach(button => {
                button.onclick = null;
                button.classList.add('cursor-not-allowed');
            });

            // 정답 표시
            optionButtons[questionData.correctAnswerIndex].classList.add('bg-green-300', 'border-2', 'border-green-500');

            // 다음 문제로 넘어가기 (1.5초 후)
            setTimeout(() => {
                nextQuestion();
            }, 1500);
        }

        /**
         * 사용자의 답변을 확인하고 피드백을 제공합니다.
         */
        function checkAnswer(selectedIndex) {
            clearInterval(timerInterval); // 답변 선택 시 타이머 중지

            const questionData = currentQuizQuestions[currentQuestionIndex];
            const optionButtons = document.querySelectorAll('.option-button');

            // 모든 버튼 비활성화
            optionButtons.forEach(button => {
                button.onclick = null;
                button.classList.add('cursor-not-allowed');
            });

            // 정답/오답 표시
            if (selectedIndex === questionData.correctAnswerIndex) {
                feedbackElem.textContent = '정답입니다!';
                feedbackElem.className = 'mt-6 text-2xl font-bold text-green-600';
                correctAnswersCount++;
                optionButtons[selectedIndex].classList.add('bg-green-300', 'border-2', 'border-green-500');
            } else {
                feedbackElem.textContent = '오답입니다!';
                feedbackElem.className = 'mt-6 text-2xl font-bold text-red-600';
                optionButtons[selectedIndex].classList.add('bg-red-300', 'border-2', 'border-red-500');
                optionButtons[questionData.correctAnswerIndex].classList.add('bg-green-300', 'border-2', 'border-green-500'); // 정답 표시
            }

            // 다음 문제로 넘어가기 (1.5초 후)
            setTimeout(() => {
                nextQuestion();
            }, 1500);
        }

        /**
         * 다음 문제로 이동하거나 퀴즈를 종료합니다.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizQuestions.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        /**
         * 퀴즈 결과를 화면에 표시합니다.
         */
        function showResults() {
            clearInterval(timerInterval); // 결과 화면 진입 시 타이머 중지
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            const totalQuestions = currentQuizQuestions.length;
            const scorePercentage = (correctAnswersCount / totalQuestions) * 100;
            scoreTextElem.textContent = `정답률: ${scorePercentage.toFixed(1)}% (${correctAnswersCount}/${totalQuestions})`;

            if (scorePercentage >= 80) {
                endingImageElem.src = "https://placehold.co/400x200/C8F0C8/000000?text=Excellent+Work!";
            } else if (scorePercentage >= 50) {
                endingImageElem.src = "https://placehold.co/400x200/FFFACD/000000?text=Good+Job!";
            } else {
                endingImageElem.src = "https://placehold.co/400x200/FFCCCC/000000?text=Keep+Practicing!";
            }
        }

        /**
         * 퀴즈를 초기 상태로 재설정하고 시작 화면으로 돌아갑니다.
         */
        function resetQuiz() {
            clearInterval(timerInterval); // 초기화 시 타이머 중지
            startScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            loadingScreen.classList.add('hidden');

            allQuestions = [];
            currentQuizQuestions = [];
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            quizStarted = false;
            errorMessageElem.classList.add('hidden');
            timeLeft = TIME_LIMIT; // 타이머 변수 초기화
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#ef4444';
        }

        /**
         * 현재 로드된 문제 데이터로 새로운 퀴즈를 시작합니다.
         */
        function playAgain() {
            startQuizFromGoogleSheet();
        }

        // 초기 로드 시 시작 화면만 보이도록 설정
        document.addEventListener('DOMContentLoaded', () => {
            startScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            loadingScreen.classList.add('hidden');
        });

    </script>
</body>
</html>
